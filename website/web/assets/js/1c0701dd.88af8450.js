"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6953],{6145(e,n,r){r.d(n,{R:()=>t,x:()=>a});var i=r(7140);const s={},d=i.createContext(s);function t(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(d.Provider,{value:n},e.children)}},7092(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"middleware","title":"Middleware","description":"Build Express-style middleware to handle cross-cutting concerns.","source":"@site/docs/middleware.md","sourceDirName":".","slug":"/middleware","permalink":"/docs/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/kessud2021/Jen.js/tree/main/website/docs/middleware.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11},"sidebar":"docs","previous":{"title":"Authentication","permalink":"/docs/auth"},"next":{"title":"Caching","permalink":"/docs/cache"}}');var s=r(5656),d=r(6145);const t={sidebar_position:11},a="Middleware",o={},l=[{value:"Middleware Overview",id:"middleware-overview",level:2},{value:"Creating Middleware",id:"creating-middleware",level:2},{value:"Middleware Types",id:"middleware-types",level:2},{value:"Middleware Chain",id:"middleware-chain",level:2},{value:"Common Middleware Patterns",id:"common-middleware-patterns",level:2},{value:"Logging",id:"logging",level:3},{value:"Authentication",id:"authentication",level:3},{value:"CORS",id:"cors",level:3},{value:"Security Headers",id:"security-headers",level:3},{value:"Request Validation",id:"request-validation",level:3},{value:"Rate Limiting",id:"rate-limiting",level:3},{value:"Compression",id:"compression",level:3},{value:"Modifying Requests",id:"modifying-requests",level:2},{value:"Modifying Responses",id:"modifying-responses",level:2},{value:"Conditional Middleware",id:"conditional-middleware",level:2},{value:"Error Handling Middleware",id:"error-handling-middleware",level:2},{value:"Middleware Ordering",id:"middleware-ordering",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Complex Example",id:"complex-example",level:2},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,s.jsx)(n.p,{children:"Build Express-style middleware to handle cross-cutting concerns."}),"\n",(0,s.jsx)(n.h2,{id:"middleware-overview",children:"Middleware Overview"}),"\n",(0,s.jsx)(n.p,{children:"Middleware functions process requests and responses. They can:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Validate requests"}),"\n",(0,s.jsx)(n.li,{children:"Log activity"}),"\n",(0,s.jsx)(n.li,{children:"Handle authentication"}),"\n",(0,s.jsx)(n.li,{children:"Set response headers"}),"\n",(0,s.jsx)(n.li,{children:"Transform data"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"creating-middleware",children:"Creating Middleware"}),"\n",(0,s.jsxs)(n.p,{children:["Create middleware files in ",(0,s.jsx)(n.code,{children:"src/middleware/"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/logging.ts\n\nimport type { Middleware } from '@src/middleware/types';\n\nexport const loggingMiddleware: Middleware = (req, res, next) => {\n  console.log(`${req.method} ${req.url}`);\n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"middleware-types",children:"Middleware Types"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/types.ts\n\nimport type { IncomingMessage, ServerResponse } from 'node:http';\n\ntype Next = () => void;\n\nexport type Middleware = (\n  req: IncomingMessage,\n  res: ServerResponse,\n  next: Next\n) => void | Promise<void>;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"middleware-chain",children:"Middleware Chain"}),"\n",(0,s.jsx)(n.p,{children:"Middleware runs in order before your route handler:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Request \u2192 Middleware 1 \u2192 Middleware 2 \u2192 Middleware 3 \u2192 Route \u2192 Response\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Register middleware in ",(0,s.jsx)(n.code,{children:"jen.config.ts"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { loggingMiddleware } from '@src/middleware/logging';\nimport { authMiddleware } from '@src/middleware/auth';\n\nconst config: FrameworkConfig = {\n  middleware: [\n    loggingMiddleware,\n    authMiddleware\n  ]\n};\n\nexport default config;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"common-middleware-patterns",children:"Common Middleware Patterns"}),"\n",(0,s.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/logging.ts\n\nexport const loggingMiddleware: Middleware = (req, res, next) => {\n  const startTime = Date.now();\n  \n  res.on('finish', () => {\n    const duration = Date.now() - startTime;\n    console.log(`${req.method} ${req.url} - ${res.statusCode} (${duration}ms)`);\n  });\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"authentication",children:"Authentication"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/auth.ts\n\nimport { verifyToken } from '@src/auth/jwt';\n\nexport const authMiddleware: Middleware = async (req, res, next) => {\n  const authHeader = req.headers['authorization'];\n  \n  if (authHeader) {\n    try {\n      const token = authHeader.replace('Bearer ', '');\n      const payload = verifyToken(token);\n      \n      // Attach user to request\n      (req as any).user = payload;\n    } catch (error) {\n      console.error('Invalid token:', error);\n    }\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cors",children:"CORS"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/cors.ts\n\nexport const corsMiddleware: Middleware = (req, res, next) => {\n  res.setHeader('access-control-allow-origin', '*');\n  res.setHeader('access-control-allow-methods', 'GET, POST, PUT, DELETE');\n  res.setHeader('access-control-allow-headers', 'content-type, authorization');\n  \n  if (req.method === 'OPTIONS') {\n    res.writeHead(200);\n    res.end();\n    return;\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"security-headers",children:"Security Headers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/security.ts\n\nexport const securityMiddleware: Middleware = (req, res, next) => {\n  res.setHeader('x-content-type-options', 'nosniff');\n  res.setHeader('x-frame-options', 'DENY');\n  res.setHeader('x-xss-protection', '1; mode=block');\n  res.setHeader('strict-transport-security', 'max-age=31536000');\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"request-validation",children:"Request Validation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/validation.ts\n\nexport const validationMiddleware: Middleware = async (req, res, next) => {\n  if (req.method === 'POST' || req.method === 'PUT') {\n    const contentType = req.headers['content-type'];\n    \n    if (!contentType?.includes('application/json')) {\n      res.writeHead(400);\n      res.end(JSON.stringify({ error: 'Content-Type must be application/json' }));\n      return;\n    }\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"rate-limiting",children:"Rate Limiting"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/rateLimit.ts\n\nconst requestCounts = new Map<string, { count: number; resetTime: number }>();\n\nexport const rateLimitMiddleware: Middleware = (req, res, next) => {\n  const ip = req.socket.remoteAddress || 'unknown';\n  const now = Date.now();\n  \n  let record = requestCounts.get(ip);\n  \n  if (!record || now > record.resetTime) {\n    record = { count: 1, resetTime: now + 60000 };  // 1 minute window\n  } else {\n    record.count++;\n  }\n  \n  requestCounts.set(ip, record);\n  \n  if (record.count > 100) {  // 100 requests per minute\n    res.writeHead(429);\n    res.end('Too many requests');\n    return;\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"compression",children:"Compression"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/compression.ts\n\nimport { createGzip } from 'node:zlib';\n\nexport const compressionMiddleware: Middleware = (req, res, next) => {\n  const acceptEncoding = req.headers['accept-encoding'] || '';\n  \n  if (acceptEncoding.includes('gzip')) {\n    res.setHeader('content-encoding', 'gzip');\n    \n    const originalEnd = res.end.bind(res);\n    const gzip = createGzip();\n    \n    gzip.pipe(res);\n    \n    (res as any).end = function(data: any, encoding: any, cb: any) {\n      if (data) {\n        gzip.write(data, encoding);\n      }\n      gzip.end(cb);\n    };\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"modifying-requests",children:"Modifying Requests"}),"\n",(0,s.jsx)(n.p,{children:"Middleware can read and modify request data:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/parseBody.ts\n\nexport const parseBodyMiddleware: Middleware = async (req, res, next) => {\n  if (req.method === 'POST' || req.method === 'PUT') {\n    const body = await readBody(req);\n    \n    try {\n      (req as any).body = JSON.parse(body);\n    } catch (error) {\n      (req as any).body = {};\n    }\n  }\n  \n  next();\n};\n\nasync function readBody(req: IncomingMessage): Promise<string> {\n  return new Promise((resolve, reject) => {\n    let data = '';\n    req.on('data', chunk => (data += chunk));\n    req.on('end', () => resolve(data));\n    req.on('error', reject);\n  });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Access in routes:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// site/api/(users).ts\n\nexport async function handle(req: IncomingMessage, res: ServerResponse) {\n  if (req.method === 'POST') {\n    const { email, name } = (req as any).body;\n    \n    // Create user...\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"modifying-responses",children:"Modifying Responses"}),"\n",(0,s.jsx)(n.p,{children:"Middleware can set headers and modify responses:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/cache.ts\n\nexport const cacheMiddleware: Middleware = (req, res, next) => {\n  if (req.method === 'GET') {\n    res.setHeader('cache-control', 'public, max-age=3600');\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"conditional-middleware",children:"Conditional Middleware"}),"\n",(0,s.jsx)(n.p,{children:"Run middleware only on certain routes:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/admin.ts\n\nexport const adminMiddleware: Middleware = (req, res, next) => {\n  if (req.url?.startsWith('/api/admin')) {\n    // Only run on /api/admin routes\n    const user = (req as any).user;\n    \n    if (!user || user.role !== 'admin') {\n      res.writeHead(403);\n      res.end('Admin access required');\n      return;\n    }\n  }\n  \n  next();\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"error-handling-middleware",children:"Error Handling Middleware"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/errorHandler.ts\n\nexport const errorHandlerMiddleware: Middleware = (req, res, next) => {\n  const originalEnd = res.end.bind(res);\n  \n  try {\n    next();\n  } catch (error) {\n    console.error('Error:', error);\n    \n    res.writeHead(500, { 'content-type': 'application/json' });\n    res.end(JSON.stringify({ \n      error: 'Internal server error' \n    }));\n  }\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"middleware-ordering",children:"Middleware Ordering"}),"\n",(0,s.jsx)(n.p,{children:"Order matters! Middleware runs in registration order:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const config: FrameworkConfig = {\n  middleware: [\n    corsMiddleware,              // 1. Handle CORS first\n    securityMiddleware,          // 2. Set security headers\n    parseBodyMiddleware,         // 3. Parse request body\n    loggingMiddleware,           // 4. Log requests\n    authMiddleware,              // 5. Check auth\n    rateLimitMiddleware,         // 6. Rate limit\n    errorHandlerMiddleware       // 7. Handle errors last\n  ]\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Keep middleware focused"})," - Do one thing well"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Don't block without reason"})," - Call ",(0,s.jsx)(n.code,{children:"next()"})," to continue"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Handle errors gracefully"})," - Prevent crashes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Log important events"})," - Track middleware activity"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Make async middleware"})," - For I/O operations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use type safety"})," - TypeScript for middleware"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Test in isolation"})," - Unit test middleware"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Document clearly"})," - Explain what each middleware does"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"complex-example",children:"Complex Example"}),"\n",(0,s.jsx)(n.p,{children:"Full-featured middleware for API protection:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// src/middleware/apiProtection.ts\n\nimport { verifyToken } from '@src/auth/jwt';\nimport { DB } from '@src/db';\n\nexport const apiProtectionMiddleware: Middleware = async (req, res, next) => {\n  // Skip non-API routes\n  if (!req.url?.startsWith('/api')) {\n    next();\n    return;\n  }\n  \n  // Skip public routes\n  if (req.url.startsWith('/api/public')) {\n    next();\n    return;\n  }\n  \n  // Require authentication\n  const authHeader = req.headers['authorization'];\n  \n  if (!authHeader) {\n    res.writeHead(401, { 'content-type': 'application/json' });\n    res.end(JSON.stringify({ error: 'Unauthorized' }));\n    return;\n  }\n  \n  try {\n    const token = authHeader.replace('Bearer ', '');\n    const payload = verifyToken(token);\n    \n    // Check user exists\n    const db = new DB();\n    await db.connect();\n    const user = await db.query('users', { where: { id: payload.userId } });\n    await db.disconnect();\n    \n    if (!user) {\n      res.writeHead(401);\n      res.end(JSON.stringify({ error: 'User not found' }));\n      return;\n    }\n    \n    // Attach user to request\n    (req as any).user = user;\n    \n    next();\n  } catch (error) {\n    res.writeHead(403, { 'content-type': 'application/json' });\n    res.end(JSON.stringify({ error: 'Invalid token' }));\n  }\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./auth",children:"Authentication"})," - Protect your API"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./api",children:"API Routes"})," - Build endpoints"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./database",children:"Database"})," - Query data in middleware"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);